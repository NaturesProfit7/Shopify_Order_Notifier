# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —Å–µ—Ä–≤–µ—Ä—É Shopify Order Notifier

## üìç –õ–æ–∫–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
```
/home/deploy/Shopify_Order_Notifier
```

## üê≥ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
- **App –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:** `shopify_order_notifier-app-1`
- **DB –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:** `shopify_orders_db` (PostgreSQL 16)
- **–ü–æ—Ä—Ç:** `0.0.0.0:8000`

## üöÄ –ó–∞–ø—É—Å–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
```bash
cd /home/deploy/Shopify_Order_Notifier
docker compose up -d
```

### –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
```bash
docker compose down
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞
```bash
cd /home/deploy/Shopify_Order_Notifier
git pull origin master
docker compose up --build -d
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
```bash
docker compose logs -f app
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
```bash
docker compose ps
```

## üîå –î–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é
- **HTTP API:** http://0.0.0.0:8000
- **FastAPI Docs:** http://0.0.0.0:8000/docs
- **Telegram –±–æ—Ç:** @Shopify_Timosh_Bot

## üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL
```bash
docker exec -it shopify_orders_db psql -U user -d shopify_orders
```

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
- `orders` - –∑–∞–∫–∞–∑—ã —Å raw_json –¥–∞–Ω–Ω—ã–º–∏ –æ—Ç Shopify
- `order_status_history` - –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
- `alembic_version` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∏–≥—Ä–∞—Ü–∏—è—Ö

### –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–∫–∞–∑–æ–≤
```bash
docker exec shopify_orders_db psql -U user -d shopify_orders -c "SELECT id, order_number FROM orders LIMIT 5;"
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞ (JSON)
```bash
docker exec shopify_orders_db psql -U user -d shopify_orders -c "SELECT raw_json FROM orders WHERE raw_json IS NOT NULL LIMIT 1;"
```

## üìã –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞

### –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
- **PDF –≥–µ–Ω–µ—Ä–∞—Ü–∏—è:** `app/services/pdf_service.py`
  - –§—É–Ω–∫—Ü–∏—è `build_order_pdf()` - –æ—Å–Ω–æ–≤–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
  - –§—É–Ω–∫—Ü–∏—è `_draw_properties()` - –≤—ã–≤–æ–¥ —Å–≤–æ–π—Å—Ç–≤ —Ç–æ–≤–∞—Ä–∞
  - –†–∞–∑–º–µ—Ä —Ç–æ–≤–∞—Ä–∞ –±–µ—Ä–µ—Ç—Å—è –∏–∑ `variant_title`
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ "–†–µ–∫–≤—ñ–∑–∏—Ç–∏":** `app/bot/routers/orders.py`
  - –§—É–Ω–∫—Ü–∏—è `on_payment_info()` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Ä–µ–∫–≤—ñ–∑–∏—Ç—ñ–≤
- **Callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏:** `app/bot/routers/callbacks.py`
  - –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- `docker-compose.yml` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
- `Dockerfile` - –æ–ø–∏—Å–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞
- `.env` - –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç—Å—è)
- `requirements.txt` - –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python

### Telegram –±–æ—Ç
- `app/bot/main.py` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
- `app/bot/routers/` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –∏ callback'–æ–≤

## üîê –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)

```bash
# Telegram
TELEGRAM_BOT_TOKEN=<–≤–∞—à —Ç–æ–∫–µ–Ω –±–æ—Ç–∞>
TELEGRAM_ALLOWED_USER_IDS=<ID –∞–¥–º–∏–Ω–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é>

# Shopify
SHOPIFY_WEBHOOK_SECRET=<—Å–µ–∫—Ä–µ—Ç –≤–µ–±—Ö—É–∫–∞>
SHOPIFY_ACCESS_TOKEN=<—Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞>
SHOPIFY_SHOP_URL=https://your-shop.myshopify.com

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
DATABASE_URL=postgresql+psycopg://user:pass@db:5432/shopify_orders
POSTGRES_USER=user
POSTGRES_PASSWORD=pass
POSTGRES_DB=shopify_orders
```

## üîß –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–∫–∞–∑–∞ Shopify (JSON)

### –ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ä–∞–∑–º–µ—Ä —Ç–æ–≤–∞—Ä–∞
- **–õ–æ–∫–∞—Ü–∏—è:** `line_items[].variant_title`
- **–ü—Ä–∏–º–µ—Ä—ã:** `"20 –º–º"`, `"40—Ö20 –º–º"`, `"1.5 –∫–≥"`
- **–í PDF –≤—ã–≤–æ–¥–∏—Ç—Å—è –∫–∞–∫:** `‚Ä¢ –†–æ–∑–º—ñ—Ä: 40—Ö20 –º–º`

### –ì–¥–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è —Å–≤–æ–π—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞
- **–õ–æ–∫–∞—Ü–∏—è:** `line_items[].properties[]`
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞:** `{name: "–ö–æ–ª—ñ—Ä –º–µ–¥–∞–ª—å–∫–∏", value: "–∑–æ–ª–æ—Ç–æ"}`
- **–í PDF:** –∫–∞–∂–¥–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ

### –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã line_item
```json
{
  "id": 15978722001199,
  "title": "–ê–¥—Ä–µ—Å–Ω–∏–∫ –∫—ñ—Å—Ç–∫–∞ COSMIC",
  "quantity": 1,
  "price": "550.00",
  "variant_title": "40—Ö20 –º–º",
  "properties": [
    {"name": "–ö–æ–ª—ñ—Ä –º–µ–¥–∞–ª—å–∫–∏", "value": "–∑–æ–ª–æ—Ç–æ"},
    {"name": "–ö–æ–ª—ñ—Ä —à–Ω—É—Ä–æ—á–∫–∞", "value": "2. –°–∏–Ω—ñ–π"},
    {"name": "–ö–ª–∏—á–∫–∞ —É–ª—é–±–ª–µ–Ω—Ü—è", "value": "–¢–æ–±—ñ–∞—Å"}
  ]
}
```

## üìù –ù–µ–¥–∞–≤–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–∫–æ–º–º–∏—Ç—ã: dd33626 ‚Üí fce19e2)

### 1Ô∏è‚É£ –†–∞–∑–º–µ—Ä –º–µ–¥–∞–ª—å–∫–∏ –≤ PDF ‚úÖ
**–§–∞–π–ª:** `app/services/pdf_service.py` (—Å—Ç—Ä–æ–∫–∏ 252-258)

**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**
- –î–æ–±–∞–≤–ª–µ–Ω –≤—ã–≤–æ–¥ —Ä–∞–∑–º–µ—Ä–∞ –∏–∑ `variant_title` –ø–µ—Ä–µ–¥ –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏
- –†–∞–∑–º–µ—Ä –≤—ã–≤–æ–¥–∏—Ç—Å—è –∫–∞–∫: `‚Ä¢ –†–æ–∑–º—ñ—Ä: 40—Ö20 –º–º`
- –ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä–∞ –Ω–µ—Ç - —Å—Ç—Ä–æ–∫–∞ –Ω–µ –≤—ã–≤–æ–¥–∏—Ç—Å—è

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
–ê–¥—Ä–µ—Å–Ω–∏–∫ –∫—ñ—Å—Ç–∫–∞ COSMIC - 40—Ö20 –º–º
–ö—ñ–ª—å–∫—ñ—Å—Ç—å: 1
–¶—ñ–Ω–∞: 550,00

‚Ä¢ –†–æ–∑–º—ñ—Ä: 40—Ö20 –º–º
‚Ä¢ –ö–æ–ª—ñ—Ä –º–µ–¥–∞–ª—å–∫–∏: –∑–æ–ª–æ—Ç–æ
‚Ä¢ –ö–æ–ª—ñ—Ä —à–Ω—É—Ä–æ—á–∫–∞: 2. –°–∏–Ω—ñ–π
‚Ä¢ –ö–ª–∏—á–∫–∞ —É–ª—é–±–ª–µ–Ω—Ü—è: –¢–æ–±—ñ–∞—Å
```

### 2Ô∏è‚É£ –§–û–ü –Ω–∞–∑–≤–∞–Ω–∏–µ ‚úÖ
**–§–∞–π–ª—ã:**
- `app/bot/routers/orders.py` (—Å—Ç—Ä–æ–∫–∏ 512, 521)
- `app/bot/routers/callbacks.py` (—Å—Ç—Ä–æ–∫–∏ 490, 510)

**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**
- –ë—ã–ª–æ: `–§–û–ü –ù–∏—Ç—è–∂—É–∫ –ö–∞—Ç–µ—Ä–∏–Ω–∞ –°–µ—Ä–≥—ñ—ó–≤–Ω–∞`
- –°—Ç–∞–ª–æ: `–§–û–ü –ö–æ–º–∞—Ä–Ω–∏—Ü—å–∫–∞ –ö–∞—Ç–µ—Ä–∏–Ω–∞ –°–µ—Ä–≥—ñ—ó–≤–Ω–∞`

**–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**
- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∫–≤—ñ–∑–∏—Ç–∞–º–∏
- –í –º–∞—Å—Å–∏–≤–µ –∫–æ–ø–∏—Ä—É–µ–º—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

### 3Ô∏è‚É£ –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ "–†–µ–∫–≤—ñ–∑–∏—Ç–∏" ‚úÖ
**–§–∞–π–ª—ã:**
- `app/bot/routers/orders.py` (—Å—Ç—Ä–æ–∫–∏ 554-559)
- `app/bot/routers/callbacks.py` (—Å—Ç—Ä–æ–∫–∏ 522-527)

**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**
- –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ 4 –∫–æ–ø–∏—Ä—É–µ–º—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- –¢–µ–∫—Å—Ç: `"–í–∞–º –±—É–¥–µ –∑—Ä—É—á–Ω—ñ—à–µ –ø–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ 200 –≥—Ä–Ω —á–∏ –ø–æ–≤–Ω–∞ –æ–ø–ª–∞—Ç–∞?"`
- –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è –≤ `track_order_file_messages`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É "–†–µ–∫–≤—ñ–∑–∏—Ç–∏":
1. –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∫–≤—ñ–∑–∏—Ç–∞–º–∏
2. –°–æ–æ–±—â–µ–Ω–∏–µ —Å –§–û–ü
3. –°–æ–æ–±—â–µ–Ω–∏–µ —Å IBAN
4. –°–æ–æ–±—â–µ–Ω–∏–µ —Å –ï–î–†–ü–û–£
5. –°–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º –ø–ª–∞—Ç–µ–∂–∞
6. –°–æ–æ–±—â–µ–Ω–∏–µ —Å –≤–æ–ø—Ä–æ—Å–æ–º –æ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–µ ‚Üê –Ω–æ–≤–æ–µ
```

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ
```bash
df -h
```

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
```bash
docker ps -a
```

### –í–æ–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```bash
docker exec -it shopify_order_notifier-app-1 bash
cd /app
ls -la
```

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
```bash
docker exec -it shopify_order_notifier-app-1 cat /app/app/services/pdf_service.py | head -100
```

### –û—á–∏—Å—Ç–∏—Ç—å –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ (–µ—Å–ª–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–æ)
```bash
docker system prune -a --volumes -f
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
```bash
docker stats
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
```bash
docker ps --format "table {{.Names}}\t{{.Status}}"
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å–ª—É—à–∞–µ—Ç –ª–∏ –ø–æ—Ä—Ç 8000
```bash
ss -tlnp | grep 8000
netstat -tlnp | grep 8000
```

## üîó Git –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:** https://github.com/NaturesProfit7/Shopify_Order_Notifier
- **–û—Å–Ω–æ–≤–Ω–∞—è –≤–µ—Ç–∫–∞:** master
- **–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç:** `fce19e2` - –í–∏–ø—Ä–∞–≤–∏–≤ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—É –≤ PDF

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–î–∏—Å–∫:** –ï—Å–ª–∏ –¥–∏—Å–∫ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è –Ω–∞ 90%+ - –≤—ã–ø–æ–ª–Ω–∏ `docker system prune -a --volumes -f`
2. **–ë–î:** PostgreSQL —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ, –¥–∞–Ω–Ω—ã–µ –≤ —Ç–æ–º–µ `pgdata:/var/lib/postgresql/data`
3. **–õ–æ–≥–∏:** –°–º–æ—Ç—Ä–∏ —á–µ—Ä–µ–∑ `docker compose logs -f app` –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–æ–±–ª–µ–º
4. **Git:** –ü–µ—Ä–µ–¥ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–µ–ª–∞–π `git pull origin master`
5. **–ö–æ–º–º–∏—Ç—ã:** –ò—Å–ø–æ–ª—å–∑—É–π `docker compose up --build -d` –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã

- **Telegram –±–æ—Ç:** @Shopify_Timosh_Bot
- **API:** http://0.0.0.0:8000
- **API docs:** http://0.0.0.0:8000/docs
