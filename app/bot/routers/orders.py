# app/bot/routers/orders.py - –û–ß–ò–©–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
"""–†–æ—É—Ç–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞–∫–∞–∑–∞–º–∏: –ø—Ä–æ—Å–º–æ—Ç—Ä, –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤, –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤"""

from aiogram import Router, F
from aiogram.types import CallbackQuery, BufferedInputFile

from app.db import get_session
from app.models import Order, OrderStatus, OrderStatusHistory
from app.bot.services.message_builder import get_status_emoji, get_status_text
from app.services.pdf_service import build_order_pdf
from app.services.vcf_service import build_contact_vcf

from .shared import (
    debug_print,
    check_permission,
    format_phone_compact,
    track_order_file_message,
    cleanup_order_files,
    update_navigation_message,
    order_card_keyboard
)

router = Router()


def build_order_card_message(order: Order, detailed: bool = False) -> str:
    """–ü–æ—Å—Ç—Ä–æ–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–∫–∞–∑–∞"""
    order_no = order.order_number or order.id
    status_emoji = get_status_emoji(order.status)
    status_text = get_status_text(order.status)

    customer_name = f"{order.customer_first_name or ''} {order.customer_last_name or ''}".strip() or "–ë–µ–∑ —ñ–º–µ–Ω—ñ"
    phone = format_phone_compact(order.customer_phone_e164)

    message = f"""üì¶ <b>–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è #{order_no}</b> ‚Ä¢ {status_emoji} {status_text}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üë§ {customer_name}
üì± {phone}"""

    if detailed and order.raw_json:
        data = order.raw_json

        # –¢–æ–≤–∞—Ä—ã
        items = data.get("line_items", [])
        if items:
            items_text = []
            for item in items[:5]:
                title = item.get("title", "")
                qty = item.get("quantity", 0)
                items_text.append(f"‚Ä¢ {title} x{qty}")

            if items_text:
                message += f"\nüõç <b>–¢–æ–≤–∞—Ä–∏:</b> {', '.join(items_text)}"
                if len(items) > 5:
                    message += f" <i>+—â–µ {len(items) - 5}</i>"

        # –î–æ—Å—Ç–∞–≤–∫–∞
        shipping = data.get("shipping_address", {})
        if shipping:
            city = shipping.get("city", "")
            address = shipping.get("address1", "")
            if city or address:
                delivery_parts = [p for p in [city, address] if p]
                message += f"\nüìç <b>–î–æ—Å—Ç–∞–≤–∫–∞:</b> {', '.join(delivery_parts)}"

        # –°—É–º–º–∞
        total = data.get("total_price", "")
        currency = data.get("currency", "UAH")
        if total:
            message += f"\nüí∞ <b>–°—É–º–∞:</b> {total} {currency}"

    message += "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    if order.comment:
        message += f"\nüí¨ <i>–ö–æ–º–µ–Ω—Ç–∞—Ä: {order.comment}</i>"

    if order.reminder_at:
        reminder_time = order.reminder_at.strftime("%d.%m %H:%M")
        message += f"\n‚è∞ <i>–ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è: {reminder_time}</i>"

    if order.processed_by_username:
        message += f"\nüë®‚Äçüíº <i>–ú–µ–Ω–µ–¥–∂–µ—Ä: @{order.processed_by_username}</i>"

    return message


@router.callback_query(F.data.regexp(r"^order:\d+:view$"))
async def on_order_view(callback: CallbackQuery):
    """–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –∑–∞–∫–∞–∑–∞"""
    order_id = int(callback.data.split(":")[1])
    debug_print(f"Order view callback: order {order_id} from user {callback.from_user.id}")

    with get_session() as session:
        order = session.get(Order, order_id)
        if not order:
            await callback.answer("‚ùå –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ", show_alert=True)
            return

        message_text = build_order_card_message(order, detailed=True)
        keyboard = order_card_keyboard(order)

        await update_navigation_message(
            callback.bot,
            callback.message.chat.id,
            callback.from_user.id,
            message_text,
            keyboard
        )

    await callback.answer()


@router.callback_query(F.data.contains(":resend:"))
async def on_resend_file(callback: CallbackQuery):
    """–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ PDF –∏–ª–∏ VCF"""
    parts = callback.data.split(":")
    order_id = int(parts[1])
    file_type = parts[3]

    debug_print(f"Resend {file_type} for order {order_id} from user {callback.from_user.id}")

    # –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞
    await cleanup_order_files(callback.bot, callback.message.chat.id, callback.from_user.id, order_id)

    with get_session() as session:
        order = session.get(Order, order_id)
        if not order or not order.raw_json:
            await callback.answer("‚ùå –î–∞–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ", show_alert=True)
            return

        try:
            if file_type == "pdf":
                pdf_bytes, pdf_filename = build_order_pdf(order.raw_json)
                pdf_file = BufferedInputFile(pdf_bytes, pdf_filename)

                customer_message = f"""üí¨ <b>–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç—É:</b>

<i>–í—ñ—Ç–∞—é, {order.customer_first_name or '–∫–ª—ñ—î–Ω—Ç–µ'} ‚ò∫Ô∏è
–í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚Ññ{order.order_number or order.id}
–í—Å–µ –≤—ñ—Ä–Ω–æ?</i>"""

                pdf_msg = await callback.bot.send_document(
                    chat_id=callback.message.chat.id,
                    document=pdf_file,
                    caption=customer_message
                )

                track_order_file_message(callback.from_user.id, order_id, pdf_msg.message_id)
                await callback.answer("‚úÖ PDF –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ")

            elif file_type == "vcf":
                vcf_bytes, vcf_filename = build_contact_vcf(
                    first_name=order.customer_first_name or "",
                    last_name=order.customer_last_name or "",
                    order_id=str(order.order_number or order.id),
                    phone_e164=order.customer_phone_e164
                )
                vcf_file = BufferedInputFile(vcf_bytes, vcf_filename)

                caption = f"üì± –ö–æ–Ω—Ç–∞–∫—Ç –∫–ª—ñ—î–Ω—Ç–∞ ‚Ä¢ #{order.order_number or order.id}"
                if order.customer_phone_e164:
                    caption += f" ‚Ä¢ {format_phone_compact(order.customer_phone_e164)}"

                vcf_msg = await callback.bot.send_document(
                    chat_id=callback.message.chat.id,
                    document=vcf_file,
                    caption=caption
                )

                track_order_file_message(callback.from_user.id, order_id, vcf_msg.message_id)
                await callback.answer("‚úÖ VCF –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ")

        except Exception as e:
            debug_print(f"Error sending {file_type} for order {order_id}: {e}", "ERROR")
            await callback.answer(f"‚ùå –ü–æ–º–∏–ª–∫–∞: {str(e)}", show_alert=True)


@router.callback_query(F.data.contains(":payment"))
async def on_payment_info(callback: CallbackQuery):
    """–ö–Ω–æ–ø–∫–∞ '–†–µ–∫–≤—ñ–∑–∏—Ç–∏'"""
    order_id = int(callback.data.split(":")[1])
    debug_print(f"Payment info for order {order_id} from user {callback.from_user.id}")

    with get_session() as session:
        order = session.get(Order, order_id)
        if not order:
            await callback.answer("‚ùå –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ", show_alert=True)
            return

        # –ü–æ–ª—É—á–∞–µ–º —Å—É–º–º—É –∑–∞–∫–∞–∑–∞
        order_total = "800"
        currency = "–≥—Ä–Ω"

        if order.raw_json:
            total_price = order.raw_json.get("total_price")
            order_currency = order.raw_json.get("currency", "UAH")
            if total_price:
                try:
                    order_total = str(int(float(total_price)))
                    currency = "–≥—Ä–Ω" if order_currency == "UAH" else order_currency
                except:
                    pass

        payment_message = f"""üí≥ <b>–†–µ–∫–≤—ñ–∑–∏—Ç–∏ –¥–ª—è –æ–ø–ª–∞—Ç–∏</b>

–ü–µ—Ä–µ–¥–∞—î–º–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤ —Ä–æ–±–æ—Ç—É –ø—ñ—Å–ª—è –ø—Ä–µ–¥–ø–ª–∞—Ç–∏, —Ç–∞–∫ —è–∫ –≤–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—è –ø–æ–≤–Ω—ñ—Å—Ç—é —ñ–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–æ 

–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —Ç–µ—Ä–º—ñ–Ω –≤–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—è —Å–∫–ª–∞–¥–∞—î 7 —Ä–æ–±–æ—á–∏—Ö –¥–Ω—ñ–≤, –æ–¥—Ä–∞–∑—É –ø–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –í–∞–º üöÄ

üõç <b>–°—É–º–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å–∫–ª–∞–¥–∞—î - {order_total} {currency}</b>

–û–ø–ª–∞—Ç—É –º–æ–∂–Ω–∞ –∑–¥—ñ–π—Å–Ω–∏—Ç–∏ –Ω–∞:
<b>–§–û–ü –ù–∏—Ç—è–∂—É–∫ –ö–∞—Ç–µ—Ä–∏–Ω–∞ –°–µ—Ä–≥—ñ—ó–≤–Ω–∞</b>
<code>UA613220010000026004340089782</code>
<b>–ï–î–†–ü–û–£:</b> 3577508940
<b>–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è:</b> –û–ø–ª–∞—Ç–∞ –∑–∞ —Ç–æ–≤–∞—Ä 

–ù–∞–¥—Å–∏–ª–∞—é –≤—Å—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –æ–∫—Ä–µ–º–æ, —â–æ–± –≤–∞–º –±—É–ª–æ –∑—Ä—É—á–Ω–æ –∫–æ–ø—ñ—é–≤–∞—Ç–∏ ‚ò∫Ô∏èüëá"""

        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞
        await cleanup_order_files(callback.bot, callback.message.chat.id, callback.from_user.id, order_id)

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        main_msg = await callback.bot.send_message(
            callback.message.chat.id,
            payment_message
        )
        track_order_file_message(callback.from_user.id, order_id, main_msg.message_id)

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
        copy_messages = [
            "UA613220010000026004340089782",
            "–§–û–ü –ù–∏—Ç—è–∂—É–∫ –ö–∞—Ç–µ—Ä–∏–Ω–∞ –°–µ—Ä–≥—ñ—ó–≤–Ω–∞",
            "3577508940",
            "–û–ø–ª–∞—Ç–∞ –∑–∞ —Ç–æ–≤–∞—Ä"
        ]

        for msg_text in copy_messages:
            copy_msg = await callback.bot.send_message(
                callback.message.chat.id,
                f"<code>{msg_text}</code>"
            )
            track_order_file_message(callback.from_user.id, order_id, copy_msg.message_id)

        await callback.answer("üí≥ –†–µ–∫–≤—ñ–∑–∏—Ç–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω—ñ")


@router.callback_query(F.data.contains(":contacted"))
async def on_contacted(callback: CallbackQuery):
    """–ö–Ω–æ–ø–∫–∞ '–ó–≤'—è–∑–∞–ª–∏—Å—å'"""
    if not check_permission(callback.from_user.id):
        await callback.answer("‚ùå –£ –≤–∞—Å –Ω–µ–º–∞—î –ø—Ä–∞–≤ –¥–ª—è —Ü—ñ—î—ó –¥—ñ—ó", show_alert=True)
        return

    order_id = int(callback.data.split(":")[1])
    debug_print(f"Status change to WAITING_PAYMENT for order {order_id} by user {callback.from_user.id}")

    with get_session() as session:
        order = session.get(Order, order_id)
        if not order:
            await callback.answer("‚ùå –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ", show_alert=True)
            return

        if order.status != OrderStatus.NEW:
            await callback.answer("‚ö†Ô∏è –°—Ç–∞—Ç—É—Å –≤–∂–µ –∑–º—ñ–Ω–µ–Ω–æ", show_alert=True)
            return

        old_status = order.status
        order.status = OrderStatus.WAITING_PAYMENT
        order.processed_by_user_id = callback.from_user.id
        order.processed_by_username = callback.from_user.username or callback.from_user.first_name

        history = OrderStatusHistory(
            order_id=order_id,
            old_status=old_status.value,
            new_status=OrderStatus.WAITING_PAYMENT.value,
            changed_by_user_id=callback.from_user.id,
            changed_by_username=callback.from_user.username or callback.from_user.first_name
        )
        session.add(history)
        session.commit()

        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        message_text = build_order_card_message(order, detailed=True)
        keyboard = order_card_keyboard(order)

        await update_navigation_message(
            callback.bot,
            callback.message.chat.id,
            callback.from_user.id,
            message_text,
            keyboard
        )

        await callback.answer("‚úÖ –°—Ç–∞—Ç—É—Å: –û—á—ñ–∫—É—î –æ–ø–ª–∞—Ç—É")

        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ —á–∞—Ç
        notification = f"üìù –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è #{order.order_number or order.id} ‚Ä¢ –°—Ç–∞—Ç—É—Å: ‚è≥ –û—á—ñ–∫—É—î –æ–ø–ª–∞—Ç—É"
        await callback.bot.send_message(callback.message.chat.id, notification)


@router.callback_query(F.data.contains(":cancel"))
async def on_cancel(callback: CallbackQuery):
    """–ö–Ω–æ–ø–∫–∞ '–°–∫–∞—Å—É–≤–∞–Ω–Ω—è'"""
    if not check_permission(callback.from_user.id):
        await callback.answer("‚ùå –£ –≤–∞—Å –Ω–µ–º–∞—î –ø—Ä–∞–≤ –¥–ª—è —Ü—ñ—î—ó –¥—ñ—ó", show_alert=True)
        return

    order_id = int(callback.data.split(":")[1])
    debug_print(f"Status change to CANCELLED for order {order_id} by user {callback.from_user.id}")

    with get_session() as session:
        order = session.get(Order, order_id)
        if not order:
            await callback.answer("‚ùå –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ", show_alert=True)
            return

        if order.status == OrderStatus.CANCELLED:
            await callback.answer("‚ö†Ô∏è –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤–∂–µ —Å–∫–∞—Å–æ–≤–∞–Ω–æ", show_alert=True)
            return

        old_status = order.status
        order.status = OrderStatus.CANCELLED

        history = OrderStatusHistory(
            order_id=order_id,
            old_status=old_status.value,
            new_status=OrderStatus.CANCELLED.value,
            changed_by_user_id=callback.from_user.id,
            changed_by_username=callback.from_user.username or callback.from_user.first_name
        )
        session.add(history)
        session.commit()

        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        message_text = build_order_card_message(order, detailed=True)
        keyboard = order_card_keyboard(order)

        await update_navigation_message(
            callback.bot,
            callback.message.chat.id,
            callback.from_user.id,
            message_text,
            keyboard
        )

        await callback.answer("‚ùå –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ")

        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        notification = f"‚ùå –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è #{order.order_number or order.id} —Å–∫–∞—Å–æ–≤–∞–Ω–æ"
        await callback.bot.send_message(callback.message.chat.id, notification)


@router.callback_query(F.data.contains(":paid"))
async def on_paid(callback: CallbackQuery):
    """–ö–Ω–æ–ø–∫–∞ '–û–ø–ª–∞—Ç–∏–ª–∏'"""
    if not check_permission(callback.from_user.id):
        await callback.answer("‚ùå –£ –≤–∞—Å –Ω–µ–º–∞—î –ø—Ä–∞–≤ –¥–ª—è —Ü—ñ—î—ó –¥—ñ—ó", show_alert=True)
        return

    order_id = int(callback.data.split(":")[1])
    debug_print(f"Status change to PAID for order {order_id} by user {callback.from_user.id}")

    with get_session() as session:
        order = session.get(Order, order_id)
        if not order:
            await callback.answer("‚ùå –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ", show_alert=True)
            return

        if order.status != OrderStatus.WAITING_PAYMENT:
            await callback.answer("‚ö†Ô∏è –ù–µ–º–æ–∂–ª–∏–≤–æ –∑–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å", show_alert=True)
            return

        old_status = order.status
        order.status = OrderStatus.PAID

        history = OrderStatusHistory(
            order_id=order_id,
            old_status=old_status.value,
            new_status=OrderStatus.PAID.value,
            changed_by_user_id=callback.from_user.id,
            changed_by_username=callback.from_user.username or callback.from_user.first_name
        )
        session.add(history)
        session.commit()

        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        message_text = build_order_card_message(order, detailed=True)
        keyboard = order_card_keyboard(order)

        await update_navigation_message(
            callback.bot,
            callback.message.chat.id,
            callback.from_user.id,
            message_text,
            keyboard
        )

        await callback.answer("‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –æ–ø–ª–∞—á–µ–Ω–æ")

        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        notification = f"üí∞ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è #{order.order_number or order.id} –æ–ø–ª–∞—á–µ–Ω–æ!"
        await callback.bot.send_message(callback.message.chat.id, notification)


@router.callback_query(F.data.startswith("orders:list:pending:offset=0"))
async def on_back_to_pending_list(callback: CallbackQuery):
    """–ö–Ω–æ–ø–∫–∞ '–î–æ —Å–ø–∏—Å–∫—É' - –≤–æ–∑–≤—Ä–∞—Ç –∫ —Å–ø–∏—Å–∫—É —Å –æ—á–∏—Å—Ç–∫–æ–π —Ñ–∞–π–ª–æ–≤"""
    debug_print(f"Back to pending list from user {callback.from_user.id}")

    # –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥ –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–∫–∞–∑–∞ - –æ—á–∏—â–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if callback.message and callback.message.text and "–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è #" in callback.message.text:
        from .shared.state import user_order_files
        # –û—á–∏—â–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if callback.from_user.id in user_order_files:
            for order_id in list(user_order_files[callback.from_user.id].keys()):
                await cleanup_order_files(
                    callback.bot,
                    callback.message.chat.id,
                    callback.from_user.id,
                    order_id
                )

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
    from .navigation import on_orders_list
    callback.data = "orders:list:pending:offset=0"
    await on_orders_list(callback)