# Shopify Order Notifier — ТЗ (черновик)

## 1) Источник событий
- **Механизм:** Shopify Webhook
- **Событие:** `orders/create` (момент оформления заказа, до оплаты)
- **Email‑парсер:** не входит в MVP (можно добавить позже)

## 2) Shopify API App и права
- **Приложение:** создаём **новый Custom App**
- **Права (scopes):**
  - `read_orders` — доступ ко всем данным заказа (номера, товары, суммы, адреса, статусы, комментарии и т.д.)
  - `read_customers` — данные покупателя (ФИО, телефон, email)

## 3) Сообщение №1 (PDF для сотрудника)
**Обязательные поля в PDF:**
- Номер заказа
- Дата заказа
- Имя и фамилия клиента
- Адрес доставки
- Товары (с полным описанием внутри)

**Оформление и форматирование:**
- Вид: **минимальный** (без брендинга на MVP)
- **Язык PDF:** украинский (UA)
- **Валюта:** UAH
- **Доставка:** PDF отправляется в Telegram сотруднику
- **Хранение:** **не хранить** (генерировать на лету и удалять после отправки)

## 4) Сообщение №2 (VCF для сотрудника)
**Содержимое визитки:**
- Поле «Имя» = Имя клиента + номер заказа (напр.: `Іван Петренко — #1694`)
- Поле «Телефон» = стандартный международный формат `+380XXXXXXXXX` (без точек)
- Форматирование с точками (`+38•0XX•XXX•XX•XX`) использовать только в текстах/подписях, **не** в самом VCF
- Email, компания, заметки — не включаем на MVP (можно добавить позже)

## 5) Сообщение №3 (текст для клиента)
- **Язык сообщения:** украинский (UA)
- **Шаблон:**
  ```
  Вітаю, {{first_name}} ☺️
  Ваше замовлення #{{order_number}}
  Все вірно?
  ```
- **Вложение:** к сообщению прикрепляется PDF из п.3

## 6) Telegram‑бот (MVP)
- **Доступ:** список разрешённых `user_id` (владелец и сотрудники), без ролей на MVP
- **Функционал на MVP:** отправлять в Telegram по каждому заказу: PDF (сообщение №1), VCF (сообщение №2), текст для клиента (сообщение №3) — без кнопок на первом этапе
- **Логи:** базовое логирование событий (получен вебхук, сгенерирован PDF/VCF, отправлено в Telegram). Логи нажатий кнопок добавим, когда появятся кнопки

## 7) Идемпотентность и обработка ошибок
- **Ключ уникальности:** `order_id` (из Shopify)
- **Дубликаты:** при повторном событии по тому же `order_id` — пропускаем обработку и пишем в лог `duplicate`
- **Ретраи:** при ошибках Shopify/Telegram — **3 попытки** с интервалом **30 секунд**

## 8) Развёртывание и окружение
- **Хостинг:** удалённый сервер (VPS, Ubuntu)
- **Контейнеризация:** используем Docker/Docker Compose с самого начала (обучение в процессе)
- **Секреты:** хранить `.env` **на сервере** (не в репозитории); при необходимости — GitHub Actions secrets
- **Админка/статус:** на MVP достаточно логов; добавим healthcheck, мини‑страницу статуса позже

## 9) Дополнительные технические параметры
- **База данных:** PostgreSQL
- **Домен:** используем домен магазина `timosh-design.com`
- **HTTPS:** настраиваем через Nginx/Caddy для приёма вебхуков (Shopify требует HTTPS)
- **Безопасность вебхука:** проверяем подпись Shopify через HMAC
- **Часовой пояс:** Europe/Kyiv
- **Формат дат:** `дд.мм.гггг`, 24‑часовой
- **Разрешённые Telegram `user_id`:** храним в `.env` на MVP (дальше — в БД)

---

## 10) Улучшения/уточнения для понятности (помогут учиться)
- **Ясные границы MVP:** кнопок в боте **нет**, email‑парсера **нет**, хранения файлов **нет**. Только приём вебхука → 3 сообщения в Telegram.
- **Чёткие приёмочные критерии:** см. DoD ниже — можно сверять, что именно готово.
- **Простой поток данных:** Shopify → FastAPI (webhook) → сервисы (PDF/VCF/Telegram) → логи/БД. Без очередей и сложных брокеров.
- **Шаблоны как файлы:** PDF‑шаблон (HTML) и шаблоны сообщений — отдельными файлами в `templates/`, чтобы их легко менять без правок кода.
- **Единый формат логов:** JSON‑логи с полями `event`, `order_id`, `status`, `error`, `timestamp`.
- **Политика PII:** персональные данные не храним; временные файлы удаляем сразу после отправки.

## 11) Критерии готовности MVP (Definition of Done)
- [ ] Эндпойнт `/webhooks/shopify/orders` принимает POST, валидирует HMAC, отвечает 200 за ≤ 1s
- [ ] Для валидного события генерируется PDF (на лету) и отправляется сотруднику в Telegram
- [ ] Генерируется `.vcf` с `FN = Имя + № заказа`, `TEL = +380…`, и отправляется
- [ ] Отправляется текст для клиента (UA) — как черновик менеджеру в Telegram
- [ ] Дубликаты по `order_id` не приводят к повторной отправке; пишется лог `duplicate`
- [ ] Ретраи работают: 3 попытки с паузой 30s при 5xx/сетевых ошибках
- [ ] Логи пишутся в файл/STDOUT в JSON‑формате
- [ ] `/health` возвращает 200 OK

## 12) Схема БД (черновик)
- **orders_processed**: `order_id (PK)`, `created_at`
- **allowed_users**: `user_id (PK)`, `added_at`
- **logs**: `id (PK)`, `timestamp`, `level`, `event`, `order_id`, `details JSONB`

## 13) Переменные окружения (.env — пример)
```
# Shopify
SHOPIFY_SHOP_DOMAIN=example.myshopify.com
SHOPIFY_ACCESS_TOKEN=xxx
SHOPIFY_WEBHOOK_SECRET=xxx

# Web
BASE_URL=https://timosh-design.com
PORT=8000

# Telegram
TELEGRAM_BOT_TOKEN=xxx
TELEGRAM_ALLOWED_USER_IDS=123456789,987654321
TELEGRAM_TARGET_CHAT_ID=-1001234567890

# Database
DATABASE_URL=postgresql+psycopg://user:pass@host:5432/dbname

# App
TIMEZONE=Europe/Kyiv
PDF_LOCALE=uk-UA
```

## 14) Эндпойнты сервиса
- `POST /webhooks/shopify/orders` — приём `orders/create`, проверка HMAC
- `GET  /health` — healthcheck

## 15) Форматы файлов и шаблонов
- **PDF:** таблица товаров (название/вариант/кол-во/цена), итоги, блок адреса и контактов
- **VCF:** `FN = Имя + № заказа`, `TEL = +380…`
- **Шаблон сообщения клиенту (UA):** см. п.5

## 16) План MVP‑спринтов / Issues
1) Каркас FastAPI + `/health` + проверка HMAC
2) Заглушки сервисов: Shopify‑клиент, PDF, VCF, Telegram — по очереди
3) Реальный рендер PDF + отправка файла в Telegram
4) Генерация VCF + отправка файла
5) Текст для клиента + проверка allowed `user_id`
6) Идемпотентность по `order_id` + JSON‑логи + ретраи
7) README с инструкцией запуска (Docker Compose)
